<template>
    <ul class="lottery_show">
        <li
            class="lottery_logo"
            :style="{'backgroundImage':`url(${require('../../assets/images/lottery-icon/'+this.$route.query.menuId+'.png')})`}"
        ></li>

        <li>
            <div>
                <p>第{{issue}}期</p>
                <p>投注剩余时间</p>
            </div>
        </li>
        <li>
            <CountDown :difftime="timercount" />
        </li>
        <li>
            <p class="lottery_history_issue">
                <span>第{{lotteryNumber.issue}}期</span>
                <span>
                    <router-link
                        style="color:#ffdc00"
                        target="_blank"
                        tag="a"
                        :to="{name:'history'}"
                    >号码走势</router-link>
                </span>
            </p>
            <p class="lottery_num_box">
                <span v-for="(item,index) of lotteryNumber.code.split(' ')" :key="index">{{item}}</span>
            </p>
        </li>
    </ul>
</template>
<script>
import CountDown from './countdown'
import { getissue, getprize } from '@/api/index'
import { EventBus } from '@/api/eventBus.js'
export default {
    name: 'lottery_show',
    data() {
        return {
            issue: '',
            timercount: 0,
            lotteryNumber: {
                code: ''
            }, //开奖结果
            opentimeList: [], //开奖时间
            openTimeOnOff: true, //开奖函数只执行一次
            count: 0,
            timerDown: '', //倒计时定时器
            timerOpenTime: '' //倒计时开奖
        }
    },
    mounted() {
        let lotteryid = sessionStorage.getItem('lotteryId')
        this.handleIssues()
        getprize({ lotteryid, size: 7 }).then(res => {
            for (const key in res.data[0]) {
                this.$set(this.lotteryNumber, key, res.data[0][key])
                this.$store.dispatch('handleOpenList', res.data)
            }
        })
    },
    methods: {
        down() {
            if (this.timercount) {
                this.timerDown = setTimeout(() => {
                    this.timercount -= 1
                    this.down()
                }, 1000)
            } else {
                this.timerDown = setTimeout(() => {
                    this.handleIssues()
                }, 1000)
            }
        },
        handleOpenTime() {
            let lotteryid = sessionStorage.getItem('lotteryId')
            let opentime = this.opentimeList[0].opentime,
                current = this.opentimeList[0].current.split('-')[1]
                    ? this.opentimeList[0].current.split('-')[1]
                    : this.opentimeList[0].current.split('-')[0]
            if (!!opentime) {
                this.timerOpenTime = setTimeout(() => {
                    this.$set(this.opentimeList[0], 'opentime', opentime - 1)
                    this.handleOpenTime()
                }, 1000)
            } else {
                getprize({ lotteryid, size: 7 }).then(res => {
                    let getCurrent = res.data[0].issue.split('-')[1]
                        ? res.data[0].issue.split('-')[1]
                        : res.data[0].issue.split('-')[0]
                    let nowissue = this.issue.split('-')[1]
                        ? this.issue.split('-')[1]
                        : this.issue.split('-')[0] //当前的奖期

                    if (current == getCurrent) {
                        this.count = 0 //从新计数
                        for (const key in res.data[0]) {
                            this.$set(this.lotteryNumber, key, res.data[0][key]) //开奖
                        }
                        this.$store.dispatch('handleOpenList', res.data)
                        this.opentimeList.shift()
                    }
                    if (current != getCurrent) {
                        this.count += 1
                        if (this.count > 3) {
                            this.opentimeList.shift()
                            this.opentimeList[0].opentime -= 3
                            this.openTimeOnOff = true
                            this.count = 0
                            //开奖失败
                            this.$set(
                                this.lotteryNumber,
                                'issue',
                                `${nowissue - 1}`
                            ) //开奖
                            this.$set(this.lotteryNumber, 'code', '- - - - -')
                        }
                    }
                    this.timerOpenTime = setTimeout(() => {
                        this.handleOpenTime()
                    }, 1000)
                })
            }
        },
        handleIssues() {
            let lotteryid = sessionStorage.getItem('lotteryId')
            getissue({
                lotteryid
            }).then(res => {
                this.saleend = res.data.saleend
                let now = Math.trunc(
                        Date.parse(res.data.nowtime.replace(/-/g, '/')) / 1000
                    ),
                    date = Math.trunc(
                        Date.parse(res.data.saleend.replace(/-/g, '/')) / 1000
                    ),
                    open = Math.trunc(
                        Date.parse(res.data.opentime.replace(/-/g, '/')) / 1000
                    ),
                    opentime = open - now
                this.timercount = date - now
                this.opentimeList.push({ current: res.data.issue, opentime })
                this.down()
                if (this.openTimeOnOff) {
                    this.handleOpenTime()
                }
                this.openTimeOnOff = false
                //奖期更新 处理 追号列表更新
                if (this.issue != res.data.issue) {
                    if (this.issue) {
                        this.$Message.info({
                            content: '当前奖期已售完，请购买下一期'
                        })
                    }

                    this.issue = res.data.issue
                    this.$store.dispatch('handleIssue', res.data.issue)
                    EventBus.$emit('updateTraceList')
                }
            })
        }
    },
    beforeDestroy() {
        //销毁时，清除定时器循环
        clearTimeout(this.timerDown)
        clearTimeout(this.timerOpenTime)
    },
    components: {
        CountDown
    }
}
</script>

<style lang="stylus" scoped>
.lottery_show
    height 92px
    border 2px solid #5a5a5a
    border-radius 6px
    background #202020
    overflow hidden
    box-shadow Boxshaow
    li
        height 100%
        float left
    .lottery_logo
        width 141px
        margin-left 16px
        border-right 1px solid #545454
        background url('../../assets/images/lottery_logo.png') left center no-repeat
    li:nth-child(2)
        width 140px
        font-size 12px
        color #fff
        line-height 26px
        div
            margin-left 20px
            margin-top 11px
            color #bbb
    li:nth-child(3)
        width 259px
        text-align center
        font-size 26px
        padding-top 16px
        color #fff
        border-right 1px solid #545454
        span
            border 4px solid #fff
            padding 10px
            border-radius 6px
            margin-right 10px
        i
            margin-right 10px
    li:nth-child(4)
        width 342px
        font-size 12px
        .lottery_history_issue
            margin-top 8px
            overflow hidden
            span:first-child
                float left
                margin-left 14px
                color #ffdc00
            span:last-child
                float right
                color #ffdc00
        .lottery_num_box
            font-size 24px
            font-weight bold
            color #ffdc00
            line-height 62px
            margin-left 20px
            span
                width 40px
                height 40px
                line-height 40px
                text-align center
                display inline-block
                border 1px solid #ffdc00
                border-radius 40px
                margin-right 28px
                color #ffdc00
                box-shadow 0 0 0 #000
                &:first-child
                    margin-left 5px
                &:last-child
                    margin-right 0
</style>
